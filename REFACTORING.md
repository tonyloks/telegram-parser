# План рефакторинга

Этот документ описывает план по рефакторингу проекта для улучшения его структуры, читаемости и поддерживаемости.

## 1. Цели рефакторинга

- **Разделение логики**: Отделить бизнес-логику (парсинг, инвайтинг) от интерфейса пользователя и конфигурации.
- **Улучшение структуры**: Создать логичную структуру папок для кода, данных и файлов сессий.
- **Устранение дублирования**: Вынести повторяющиеся фрагменты кода в переиспользуемые функции.
- **Повышение читаемости**: Использовать понятные имена для файлов, функций и переменных.

## 2. Новая архитектура проекта

Предлагается следующая структура каталогов:

```
/
├── data/
│   ├── usernames.txt
│   ├── userids.txt
│   └── options.txt
├── sessions/
│   └── (здесь будут храниться файлы *.session)
├── src/
│   ├── __init__.py
│   ├── main.py             # Точка входа, главное меню
│   ├── actions.py          # Функции парсинга и инвайтинга
│   ├── config_handler.py   # Работа с файлом конфигурации и .env
│   └── utils.py            # Вспомогательные утилиты (выбор сессии и т.д.)
├── config/
│   └── config.yaml         # Главный конфигурационный файл (YAML)
├── .env                    # Хранение API_ID и API_HASH
├── tests/
│   ├── test_config_handler.py  # Тесты для config_handler
│   ├── test_actions.py         # Тесты для actions
│   └── test_utils.py           # Тесты для utils
├── REFACTORING.md          # Этот файл
└── requirements.txt
```

### Описание модулей `src/`:

- **`main.py`**:
    - Главный цикл приложения с меню (Настройки, Парсинг, Инвайтинг).
    - Вызов функций из других модулей для выполнения выбранных действий.

- **`actions.py`**:
    - Будет содержать основные функции бизнес-логики:
        - `parse_chats(...)` - логика парсинга участников из групп.
        - `invite_users(...)` - логика инвайтинга пользователей в группу.
    - Эта логика будет перенесена из `main.py` и `defunc.py`.

- **`config_handler.py`**:
    - Логика разделена на два блока:
        - **Работа с конфигурацией выгрузок**: функции для чтения и изменения параметров из `config/config.yaml` (YAML).
        - **Работа с пользовательскими данными**: функции для чтения и изменения API_ID и API_HASH из `.env`.
    - `get_config()`: Читает параметры из `config/config.yaml` (YAML).
    - `get_user_data()`: Читает API_ID и API_HASH из `.env`.
    - `setup_config()`: Меню для настройки и изменения параметров выгрузки.
    - `setup_user_data()`: Меню для настройки и изменения API_ID и API_HASH.
    - При обращении к API_ID и API_HASH функция должна брать их из `.env` и обрабатывать случаи, когда значения отсутствуют или пустые (например, выводить предупреждение или запрашивать ввод).
    - Вся логика работы с конфигом теперь через YAML-файл и .env.
    - Перенос логики из `main.py` и `defunc.py`.

- **`utils.py`**:
    - `select_session(sessions_path)`: Функция для отображения списка доступных `.session` файлов и запроса выбора от пользователя. Возвращает путь к выбранной сессии.
    - Другие мелкие вспомогательные функции, которые могут понадобиться.

### Описание папки `tests/`:

- **`test_config_handler.py`**: Тесты для функций работы с конфигом и .env.
- **`test_actions.py`**: Тесты для бизнес-логики парсинга и инвайтинга.
- **`test_utils.py`**: Тесты для вспомогательных функций.

## 3. Пошаговый план реализации

### Шаг 1: Создание новой структуры папок

1.  Создать папку `src`.
2.  Создать папку `data`.
3.  Создать папку `sessions`.
4.  Создать пустые файлы `src/__init__.py`, `src/actions.py`, `src/config_handler.py`, `src/utils.py`.

### Шаг 2: Перемещение существующих файлов

1.  Переместить `options.txt`, `usernames.txt`, `userids.txt` в папку `data/`.
2.  Переместить все файлы с расширением `.session` в папку `sessions/`.
3.  Переместить `main.py` в `src/`.

### Шаг 3: Рефакторинг `config_handler.py`

1.  Перенести функции работы с конфигом из `defunc.py` в `src/config_handler.py`.
2.  Переименовать их в `get_config` и `setup_config` для единообразия.
3.  Изменить работу с файлом: теперь используется `config/config.yaml` (формат YAML).

### Шаг 4: Рефакторинг `utils.py`

1.  Создать в `src/utils.py` функцию `select_session(sessions_path)`.
2.  Вырезать логику выбора сессии, которая повторяется в `main.py` для парсинга и инвайтинга, и вставить её в эту функцию. Функция должна возвращать путь к выбранному файлу сессии.

### Шаг 5: Рефакторинг `actions.py`

1.  Перенести функцию `parsing` из `defunc.py` в `src/actions.py`. Переименовать в `parse_group_members`.
2.  Перенести функцию `inviting` из `defunc.py` в `src/actions.py`. Переименовать в `invite_user_to_channel`.
3.  Перенести логику парсинга и инвайтинга из циклов в `main.py` в `src/actions.py`, создав функции-обертки `run_parsing` и `run_inviting`. Эти функции будут управлять всем процессом: от выбора сессии до вызова `parse_group_members` или `invite_user_to_channel` в цикле.
4.  Обновить пути к файлам `usernames.txt` и `userids.txt` на `data/usernames.txt`.

### Шаг 6: Рефакторинг `main.py`

1.  Удалить весь старый код, связанный с парсингом, инвайтингом и конфигурацией.
2.  Импортировать необходимые функции из `src.actions`, `src.config_handler` и `src.utils`.
3.  В главном цикле `while` оставить только логику меню.
4.  Выбор "Настройки" должен вызывать `setup_config()`.
5.  Выбор "Парсинг" должен вызывать `run_parsing()`.
6.  Выбор "Инвайтинг" должен вызывать `run_inviting()`.

### Шаг 7: Финальная очистка

1.  Убедиться, что все импорты в файлах `src/*` корректны (например, `from . import utils`).
2.  Удалить старый файл `defunc.py`.
3.  Проверить, что все пути к файлам в `data/` и `sessions/` указаны правильно относительно корня проекта.
4.  Обновить `requirements.txt` при необходимости. 